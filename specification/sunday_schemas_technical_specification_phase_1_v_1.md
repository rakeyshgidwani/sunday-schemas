# sunday-schemas — Technical Specification (Phase 1 v1)

> Scope: **Phase 1 only**. This repo is the single source of truth for **event schemas** (Kafka topics) and the **UI HTTP API spec** used by Phase‑1 services. It also publishes **generated types** for TypeScript and Go. No business logic runs here.

---

## 1) Purpose & Deliverables
**Purpose**  
Provide versioned, machine‑validated definitions for:
- **Raw envelope** emitted by `sunday-connectors` (`raw.v0`).
- **Normalized market data** (`md.*`) emitted by `sunday-data/normalizer`.
- **Insights (lite)** (`insights.*`) emitted by `sunday-data/insights-lite`.
- **Infra health** (`infra.venue_health`) emitted by `sunday-data/venue-health`.
- **UI BFF HTTP** responses for `/ui/*` (OpenAPI 3.1).  

**Deliverables**
- JSON Schemas (`/schemas/json/`)
- OpenAPI 3.1 spec (`/openapi/ui.v1.yaml`)
- Generated types:
  - npm: `@sunday/schemas` (TS types, OpenAPI types)
  - Go module: `github.com/sunday-xyz/schemas/go`
- CI checks: validation, backward‑compat, versioning, changelog.

---

## 2) Versioning & Compatibility
- **Semantic Versioning** for the repo: `MAJOR.MINOR.PATCH` (e.g., `1.2.0`).
- **Events** use a schema id field (e.g., `schema: "raw.v0"`).  
- **Allowed in Phase 1**: Backward‑compatible changes only (add optional fields, widen enums).  
- **Breaking changes** (field removal/rename, type changes) **not allowed** in Phase 1. If unavoidable → bump **MAJOR** and coordinate consumers.
- **CI** uses diff tools to ensure compatibility (see §10).

---

## 3) Repository Layout
```
/sunday-schemas
  /schemas
    /json
      raw.v0.envelope.schema.json
      md.orderbook.delta.v1.schema.json
      md.trade.v1.schema.json
      insights.arb.lite.v1.schema.json
      insights.movers.v1.schema.json
      insights.whales.lite.v1.schema.json
      insights.unusual.v1.schema.json
      infra.venue_health.v1.schema.json
    /examples
      raw.polymarket.orderbook.example.json
      raw.kalshi.trade.example.json
      md.orderbook.delta.example.json
      ...
    /registries
      venues.json                 # authoritative venue list for enums (e.g., ["polymarket","kalshi"])
      instruments.json            # optional seed/canonicalization notes (generated by normalizer)
    topics.json                   # canonical schema↔topic map
  /openapi
    ui.v1.yaml
  /codegen
    /ts
    /go
  /docs
    mapping.md                   # raw→normalized rules (ids, YES/NO, prob conventions)
  /scripts
  CHANGELOG.md
  README.md
```

## 3.1 Topic Map & Registries
- **`/schemas/topics.json`** — single source of truth mapping schema IDs to Kafka topics (env prefix applied by deploy config). Example:
```json
{
  "md.orderbook.delta.v1": "md.normalized.orderbook",
  "md.trade.v1": "md.trades",
  "insights.arb.lite.v1": "insights.arb.lite",
  "insights.movers.v1": "insights.movers",
  "insights.whales.lite.v1": "insights.whales.lite",
  "insights.unusual.v1": "insights.unusual",
  "infra.venue_health.v1": "infra.venue_health"
}
```
- **`/schemas/registries/venues.json`** — authoritative list of supported `venue_id` values used to **generate enums** in schemas. Adding a venue is a **minor** version bump.
- **`/schemas/registries/instruments.json`** — (optional) seed file or notes generated by the normalizer for canonical `instrument_id` rules.

---

## 4) Event Schemas (JSON Schema, draft/2020‑12)

### 4.1 `raw.v0` Envelope (from sunday-connectors)
**Topic(s):** `raw.venue.{venue}.orderbook`, `raw.venue.{venue}.trades`  
**Rule:** `payload` must be a **single venue message object** (no arrays) in Phase 1.
```json
{
  "$id": "https://schemas.sunday.dev/raw.v0.envelope.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Raw Envelope v0",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "raw.v0"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "stream": {"enum": ["orderbook", "trades", "status"]},
    "instrument_native": {"type": "string", "minLength": 1},
    "partition_key": {"type": "string", "minLength": 1},
    "ts_event_ms": {"type": "integer", "minimum": 0, "$comment": "epoch ms from venue event, if available"},
    "ts_ingest_ms": {"type": "integer", "minimum": 0, "$comment": "epoch ms when connector enqueued event"},
    "is_historical": {"type": "boolean", "default": false},
    "backfill_ts_ms": {"type": "integer", "minimum": 0, "$comment": "epoch ms when backfill job ran"},
    "payload": {"type": "object"}
  },
  "required": [
    "schema", "venue_id", "stream", "instrument_native",
    "partition_key", "ts_event_ms", "ts_ingest_ms", "payload"
  ]
}
```json
{
  "$id": "https://schemas.sunday.dev/raw.v0.envelope.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Raw Envelope v0",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "raw.v0"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "stream": {"enum": ["orderbook", "trades", "status"]},
    "instrument_native": {"type": "string", "minLength": 1},
    "partition_key": {"type": "string", "minLength": 1},
    "ts_event_ms": {"type": "integer", "minimum": 0},
    "ts_ingest_ms": {"type": "integer", "minimum": 0},
    "is_historical": {"type": "boolean", "default": false},
    "backfill_ts_ms": {"type": "integer", "minimum": 0},
    "payload": {"type": "object"}
  },
  "required": [
    "schema", "venue_id", "stream", "instrument_native",
    "partition_key", "ts_event_ms", "ts_ingest_ms", "payload"
  ]
}
```

### 4.2 `md.normalized.orderbook` (delta with optional snapshot)
**Topic:** `md.normalized.orderbook`  
**Notes:** Prices are **implied probability** in `[0.0, 1.0]`. Depth arrays are `[price, size]` pairs.  
**Sequencing:** `seq` must be **monotonic per (`instrument_id`,`venue_id`)**. If a gap is detected, the next message **MUST** set `is_snapshot=true` and carry a full book before resuming deltas.
```json
{
  "$id": "https://schemas.sunday.dev/md.orderbook.delta.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Normalized Order Book Delta v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "md.orderbook.delta.v1"},
    "instrument_id": {"type": "string", "minLength": 1},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "seq": {"type": "integer", "minimum": 0, "$comment": "monotonic per instrument_id+venue_id"},
    "ts_ms": {"type": "integer", "minimum": 0, "$comment": "epoch ms"},
    "bids": {
      "type": "array",
      "$comment": "array of [prob, size] pairs",
      "items": {"type": "array", "items": [{"type":"number"},{"type":"number"}], "minItems": 2, "maxItems": 2}
    },
    "asks": {
      "type": "array",
      "$comment": "array of [prob, size] pairs",
      "items": {"type": "array", "items": [{"type":"number"},{"type":"number"}], "minItems": 2, "maxItems": 2}
    },
    "is_snapshot": {"type": "boolean", "default": false, "$comment": "true when full book supplied after a gap"}
  },
  "required": ["schema", "instrument_id", "venue_id", "seq", "ts_ms", "bids", "asks", "is_snapshot"]
}
```json
{
  "$id": "https://schemas.sunday.dev/md.orderbook.delta.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Normalized Order Book Delta v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "md.orderbook.delta.v1"},
    "instrument_id": {"type": "string", "minLength": 1},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "seq": {"type": "integer", "minimum": 0},
    "ts_ms": {"type": "integer", "minimum": 0},
    "bids": {
      "type": "array",
      "items": {"type": "array", "items": [{"type":"number"},{"type":"number"}], "minItems": 2, "maxItems": 2}
    },
    "asks": {
      "type": "array",
      "items": {"type": "array", "items": [{"type":"number"},{"type":"number"}], "minItems": 2, "maxItems": 2}
    },
    "is_snapshot": {"type": "boolean", "default": false}
  },
  "required": ["schema", "instrument_id", "venue_id", "seq", "ts_ms", "bids", "asks", "is_snapshot"]
}
```

### 4.3 `md.trades`
**Topic:** `md.trades`  
```json
{
  "$id": "https://schemas.sunday.dev/md.trade.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Normalized Trade v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "md.trade.v1"},
    "instrument_id": {"type": "string"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "ts_ms": {"type": "integer", "minimum": 0, "$comment": "epoch ms"},
    "side": {"enum": ["buy", "sell"]},
    "prob": {"type": "number", "minimum": 0.0, "maximum": 1.0, "$comment": "implied probability"},
    "size": {"type": "number", "minimum": 0},
    "notional_usd": {"type": "number", "minimum": 0}
  },
  "required": ["schema", "instrument_id", "venue_id", "ts_ms", "side", "prob", "size"]
}
```json
{
  "$id": "https://schemas.sunday.dev/md.trade.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Normalized Trade v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "md.trade.v1"},
    "instrument_id": {"type": "string"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "ts_ms": {"type": "integer", "minimum": 0},
    "side": {"enum": ["buy", "sell"]},
    "price_prob": {"type": "number", "minimum": 0.0, "maximum": 1.0},
    "size": {"type": "number", "minimum": 0},
    "notional_usd": {"type": "number", "minimum": 0}
  },
  "required": ["schema", "instrument_id", "venue_id", "ts_ms", "side", "price_prob", "size"]
}
```

### 4.4 `insights.arb.lite`
**Topic:** `insights.arb.lite`  
```json
{
  "$id": "https://schemas.sunday.dev/insights.arb.lite.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Arbitrage (Lite) v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "insights.arb.lite.v1"},
    "instrument_id": {"type": "string"},
    "long_venue": {"enum": ["polymarket", "kalshi"]},
    "short_venue": {"enum": ["polymarket", "kalshi"]},
    "edge_bps": {"type": "number"},
    "depth_tier": {"enum": ["S", "M", "L"]},
    "persistence_ms": {"type": "integer", "minimum": 0},
    "last_seen_ms": {"type": "integer", "minimum": 0},
    "fees_included": {"type": "boolean"}
  },
  "required": ["schema", "instrument_id", "long_venue", "short_venue", "edge_bps", "depth_tier", "persistence_ms", "last_seen_ms", "fees_included"]
}
```

### 4.5 `insights.movers`
**Topic:** `insights.movers`  
```json
{
  "$id": "https://schemas.sunday.dev/insights.movers.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Movers v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "insights.movers.v1"},
    "instrument_id": {"type": "string"},
    "window": {"enum": ["1h", "24h"]},
    "prob_now": {"type": "number", "minimum": 0.0, "maximum": 1.0},
    "prob_prev": {"type": "number", "minimum": 0.0, "maximum": 1.0},
    "delta_bps": {"type": "integer"},
    "imbalance_index": {"type": "integer", "minimum": 0, "maximum": 100},
    "ts_ms": {"type": "integer", "minimum": 0}
  },
  "required": ["schema", "instrument_id", "window", "prob_now", "prob_prev", "delta_bps", "imbalance_index", "ts_ms"]
}
```

### 4.6 `insights.whales.lite`
**Topic:** `insights.whales.lite`  
```json
{
  "$id": "https://schemas.sunday.dev/insights.whales.lite.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Whale Flows (Lite) v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "insights.whales.lite.v1"},
    "instrument_id": {"type": "string"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "impact": {"enum": ["LOW", "MED", "HIGH"]},
    "direction": {"enum": ["buy", "sell"]},
    "post_move_bps": {"type": "integer"},
    "ts_ms": {"type": "integer", "minimum": 0}
  },
  "required": ["schema", "instrument_id", "venue_id", "impact", "direction", "post_move_bps", "ts_ms"]
}
```

### 4.7 `insights.unusual`
**Topic:** `insights.unusual`  
```json
{
  "$id": "https://schemas.sunday.dev/insights.unusual.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Unusual Activity v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "insights.unusual.v1"},
    "instrument_id": {"type": "string"},
    "metric": {"enum": ["volume", "volatility"]},
    "window": {"enum": ["1h", "24h"]},
    "zscore": {"type": "number"},
    "ts_ms": {"type": "integer", "minimum": 0}
  },
  "required": ["schema", "instrument_id", "metric", "window", "zscore", "ts_ms"]
}
```

### 4.8 `infra.venue_health`
**Topic:** `infra.venue_health`  
```json
{
  "$id": "https://schemas.sunday.dev/infra.venue_health.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Venue Health v1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema": {"const": "infra.venue_health.v1"},
    "venue_id": {"enum": ["polymarket", "kalshi"]},
    "status": {"enum": ["CONNECTED", "DEGRADED", "STALE"]},
    "last_event_ts_ms": {"type": "integer", "minimum": 0},
    "messages_per_second": {"type": "number", "minimum": 0},
    "staleness_seconds": {"type": "number", "minimum": 0},
    "observed_at_ms": {"type": "integer", "minimum": 0}
  },
  "required": ["schema", "venue_id", "status", "last_event_ts_ms", "observed_at_ms"]
}
```

---

## 5) OpenAPI (UI BFF) — `ui.v1`
**File:** `/openapi/ui.v1.yaml` (OpenAPI 3.1)  
**Base URL:** `/ui/*` (auth required at gateway; not modeled here).  

**Endpoints** (schemas reuse event models where applicable):
- `GET /markets` → `MarketList` (includes instrument_id, title, venues, implied_prob_now, prob_change_1h/24h, volume_24h, time_to_resolution, deep_link)
- `GET /arb` → array of `ArbLite`
- `GET /movers` → array of `Mover`
- `GET /flows` → array of `WhaleLite`
- `GET /unusual` → array of `Unusual`
- `GET /calendar` → array of `ResolutionEvent`
- `GET /venue-health` → array of `VenueHealth`

**Parameters** (examples):
- `/arb`: `min_edge_bps` (int), `venues` (csv enum), `limit` (1..200)
- `/movers`: `window` (enum 1h|24h), `limit` (1..200)

**Components** (sketch):
```yaml
components:
  schemas:
    ArbLite:
      type: object
      properties:
        instrument_id: { type: string }
        long_venue: { type: string, enum: [polymarket, kalshi] }
        short_venue: { type: string, enum: [polymarket, kalshi] }
        edge_bps: { type: number }
        depth_tier: { type: string, enum: [S, M, L] }
        persistence_ms: { type: integer, minimum: 0 }
        last_seen_ms: { type: integer, minimum: 0 }
        fees_included: { type: boolean }
      required: [instrument_id, long_venue, short_venue, edge_bps, depth_tier, persistence_ms, last_seen_ms, fees_included]
```
(Full YAML in repo.)

---

## 6) Code Generation
**TypeScript**  
- Tool: `json-schema-to-typescript` for event models; `openapi-typescript` for OpenAPI.  
- Output: `packages/ts/index.d.ts` published as `@sunday/schemas`.

**Go**  
- Tool: `oapi-codegen` for OpenAPI client/server types; `quicktype` (CLI) or `github.com/santhosh-tekuri/jsonschema/v5` + handrolled structs for JSON schemas.  
- Output: `go/` module `github.com/sunday-xyz/schemas/go`.

**Publishing**  
- GitHub Actions flows: tag → build → publish npm + Go module (goreleaser).  
- Artifacts: schema files, generated types, checksum/SBOM.

---

## 7) Validation & Linters
- `ajv` (Node) for JSON Schema validation tests against `/schemas/examples/*`.
- `spectral` for OpenAPI linting (naming, consistency).
- `jsonlint`/`yamllint` for structure checks.
- Unit tests: ensure all examples validate; ensure enums reflect current venues.

---

## 8) Backward‑Compatibility Gates (CI)
- **json‑schema‑diff**: fail PRs that remove required fields or narrow enums.
- **oas‑diff**: fail PRs that break OpenAPI (remove fields, change types).
- **topics.json guard**: fail PRs where a schema ID maps to a different topic or a topic is removed without deprecation.
- **venues.json guard**: adding a venue is **minor** (ok); removing/renaming is **breaking** (blocked in Phase‑1).
- **CHANGELOG.md** enforcement: PR must include an entry with SemVer bump.
- **Tagging**: releasing `v1.x.y` requires green compatibility checks.

---

## 9) Governance & Process
- **Ownership:** Schema Working Group (1 engineer from UI, Platform, Data).  
- **Change flow:** Proposal → PR with schema + examples → CI checks → review by WG → merge → tag & publish packages.  
- **Deprecations:** Mark field with `x-deprecated: true` (OpenAPI) / `$comment` in JSON Schema; maintain at least one minor version overlap.

---

## 10) Examples (excerpt)
**Example — `insights.arb.lite`**
```json
{
  "schema": "insights.arb.lite.v1",
  "instrument_id": "pm_us_election_2028_winner",
  "long_venue": "polymarket",
  "short_venue": "kalshi",
  "edge_bps": 43.5,
  "depth_tier": "M",
  "persistence_ms": 120000,
  "last_seen_ms": 1758763048123,
  "fees_included": false
}
```

**Example — `infra.venue_health`**
```json
{
  "schema": "infra.venue_health.v1",
  "venue_id": "polymarket",
  "status": "DEGRADED",
  "last_event_ts_ms": 1758763000000,
  "messages_per_second": 152.4,
  "staleness_seconds": 2.7,
  "observed_at_ms": 1758763048000
}
```

**Example — `md.trade.v1`**
```json
{
  "schema": "md.trade.v1",
  "instrument_id": "pm_us_election_2028_winner",
  "venue_id": "polymarket",
  "ts_ms": 1758763048123,
  "side": "buy",
  "prob": 0.63,
  "size": 1200,
  "notional_usd": 756
}
```

---

## 11) Acceptance Criteria (Phase 1)
1. All schemas validate with examples; npm & Go packages publish on tag.
2. OpenAPI `/ui/*` compiles; mock server (prism) can serve sample data.
3. Downstream repos (`sunday-data`, `sunday-platform`, `sunday-ui`) compile against `@sunday/schemas` and Go module at version `v1.0.0`.
4. CI gates block incompatible schema changes; CHANGELOG documents every release.

