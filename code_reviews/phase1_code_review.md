# Sunday Schemas Phase 1 Code Review

## Summary
- Blocking issues found in generated TypeScript and Go artifacts prevent downstream consumers from compiling against the repo, violating Phase 1 expectations.
- CI/validation tooling is incomplete: example validation does not exercise the schemas with Ajv and compatibility checks skip the mandated OpenAPI diff.
- Fixing the blockers below is required before the implementation can be considered compliant with the specifications.

## Blocking Issues
- **Blocking – Generated TS index exports reference non-existent symbols** (`codegen/ts/index.ts:12-29`, `codegen/ts/raw.v0.envelope.schema.d.ts:11`, `codegen/ts/md.orderbook.delta.v1.schema.d.ts:11`, `codegen/ts/insights.whales.lite.v1.schema.d.ts:11`): the index re-exports `RawV0Envelope`, `NormalizedOrderbookDeltaV1`, and `WhalesLiteV1`, but the generated `.d.ts` files expose `RawEnvelopeV0`, `NormalizedOrderBookDeltaV1`, and `WhaleFlowsLiteV1`. TypeScript consumers will get "Cannot find exported member" errors, so `@sunday/schemas` cannot compile, breaching the requirement for generated TS types (`specification/sunday_schemas_technical_specification_phase_1_v_1.md:394-403`, `specification/sunday_schemas_technical_specification_phase_1_v_1.md:479-483`).
- **Blocking – Go module diverges from the JSON schema** (`codegen/go/types.go:12-20`, `codegen/go/constants.go:23`): the `RawEnvelope` struct omits required fields (`stream`, `partition_key`, `ts_ingest_ms`) and introduces non-schema fields (`ts_received_ms`, `seq_num`), so Go services built from this file cannot round-trip valid `raw.v0` events (`specification/sunday_schemas_technical_specification_phase_1_v_1.md:93-115`). Additionally, the generated constant for the raw schema is `raw.v0.envelope` instead of `raw.v0`, so `ValidateSchema` will reject legitimate messages, breaking the downstream compile goal (`specification/sunday_schemas_technical_specification_phase_1_v_1.md:20-22`, `specification/sunday_schemas_technical_specification_phase_1_v_1.md:479-483`).
- **Blocking – Health status enums exported in TS/Go do not match the schema** (`codegen/ts/index.ts:49`, `codegen/go/constants.go:45-48`, `specification/sunday_schemas_technical_specification_phase_1_v_1.md:332-348`): both language targets expose lowercase `"connected"|"degraded"|"stale"`, whereas the schema and OpenAPI contract require uppercase (`"CONNECTED"|...`). Consumers that rely on the exported enums will emit values the API rejects, and validators using the Go constants will flag true schema values as invalid.
- **Blocking – Example validation script skips Ajv validation** (`scripts/validate-examples.js:69-107`): the script only checks for presence of required fields and even short-circuits entirely when there are no examples. The Phase 1 spec explicitly calls for Ajv-based validation of `/schemas/examples/*` (`specification/sunday_schemas_technical_specification_phase_1_v_1.md:409-413`, `specification/sunday_schemas_technical_specification_phase_1_v_1.md:479-481`), so invalid shapes (e.g., `prob` outside `[0,1]`) will slip through CI.
- **Blocking – Compatibility gate omits mandated diffs** (`scripts/check-compatibility.js:175-225`): the script hand-rolls property checks and leaves `oas-diff` as a TODO, contrary to the required Phase 1 gates (`specification/sunday_schemas_technical_specification_phase_1_v_1.md:417-423`). Without `json-schema-diff` / `oas-diff`, breaking changes to either the event schemas or the UI API can merge undetected.

## Suggested Next Steps
1. Regenerate or hand-fix `codegen/ts/index.ts` to align with the actual symbol names (`RawEnvelopeV0`, `NormalizedOrderBookDeltaV1`, `WhaleFlowsLiteV1`, etc.) and add tests that exercise the re-exports.
2. Re-run Go code generation so `RawEnvelope` and the schema constants mirror the JSON definitions (restore required fields, drop non-schema ones, ensure `SchemaRAW_V0` resolves to `raw.v0`, and export uppercase health statuses).
3. Update the TypeScript and Go health status enums to use the uppercase values defined in the schema/OpenAPI.
4. Replace the bespoke required-field check in `scripts/validate-examples.js` with true Ajv validation against the compiled schemas, failing CI when examples violate type/enum constraints.
5. Wire `json-schema-diff` and `oas-diff` (or equivalent) into `scripts/check-compatibility.js`, removing the TODO and ensuring the Phase 1 compatibility gates actually block breaking changes.
